<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComPAS ユーザー情報管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .table-container {
            max-height: calc(100vh - 300px); /* Adjust based on header/footer height */
            overflow-y: auto;
            overflow-x: auto; /* Added for horizontal scrolling if content overflows */
        }
        .sortable:hover {
            cursor: pointer;
            background-color: #f0f4f8; /* Light blue hover for sortable headers */
        }
        .sort-icon {
            margin-left: 5px;
            opacity: 0.6;
        }
        .sort-icon.active {
            opacity: 1;
            color: #3b82f6; /* Blue color for active sort icon */
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Ensure select dropdowns are visible */
        select {
            -webkit-appearance: menulist-button; /* For Safari/Chrome */
            -moz-appearance: menulist-button; /* For Firefox */
            appearance: menulist-button; /* Standard */
        }
        /* Styling for filter inputs */
        .filter-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem; /* 14px */
        }
        /* Password visibility toggle */
        .password-toggle-icon {
            cursor: pointer;
            position: absolute;
            right: 0.75rem; /* 12px */
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280; /* gray-500 */
        }
         /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #28a745; } /* Green */
        .toast.error { background-color: #dc3545; } /* Red */
        .toast.info { background-color: #17a2b8; } /* Blue */
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl sm:text-2xl font-semibold text-blue-600">ComPAS ユーザー情報管理</h1>
                <button id="hamburger-button" class="text-gray-600 hover:text-blue-600 focus:outline-none md:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <nav class="hidden md:flex space-x-4">
                    <button id="logout-button-desktop" class="text-gray-600 hover:text-blue-600">ログアウト</button>
                    <button id="my-page-button-desktop" class="text-gray-600 hover:text-blue-600">マイページに戻る</button>
                </nav>
            </div>
        </div>
    </header>

    <div id="hamburger-menu-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">メニュー</h2>
                <button id="close-hamburger-modal-button" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="flex flex-col space-y-3">
                <button id="logout-button-mobile" class="block w-full text-left px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 hover:text-blue-600">ログアウト</button>
                <button id="my-page-button-mobile" class="block w-full text-left px-3 py-2 rounded-md text-gray-700 hover:bg-gray-100 hover:text-blue-600">マイページに戻る</button>
            </nav>
        </div>
    </div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex-grow">
                    <input type="text" id="global-search-input" placeholder="全体検索 (名前, Email, 役割)..." class="filter-input w-full sm:max-w-xs shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                     <button id="create-user-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out w-full sm:w-auto">
                        <i class="fas fa-plus mr-2"></i>ユーザー作成
                    </button>
                    <button id="refresh-data-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out w-full sm:w-auto" title="データを再読み込み">
                        <i class="fas fa-sync-alt mr-2"></i>更新
                    </button>
                </div>
            </div>

            <div id="bulk-actions-container" class="mb-4 hidden flex flex-col sm:flex-row gap-2">
                <span id="selected-count" class="mr-4 self-center text-sm text-gray-600"></span>
                <button id="activate-selected-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow transition duration-150 w-full sm:w-auto">
                    <i class="fas fa-check-circle mr-1"></i>選択を有効化
                </button>
                <button id="deactivate-selected-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow transition duration-150 w-full sm:w-auto">
                    <i class="fas fa-minus-circle mr-1"></i>選択を無効化
                </button>
                <button id="delete-selected-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow transition duration-150 w-full sm:w-auto">
                    <i class="fas fa-trash-alt mr-1"></i>選択を削除
                </button>
            </div>

            <div class="table-container border border-gray-200 rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="id">ID <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="email">Email <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="name">名前 <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="role">役割 <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="is_active">状態 <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="last_login_at">最終ログイン <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="created_at">作成日時 <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="play_count">プレイ回数 <i class="fas fa-sort sort-icon"></i></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-sort="last_play_date">最終プレイ日時 <i class="fas fa-sort sort-icon"></i></th>
                        </tr>
                        <tr class="bg-gray-100 sticky top-[calc(3rem+1px)] z-10"> <th class="px-4 py-2"></th> <th class="px-4 py-2"><input type="text" class="filter-input" data-filter-column="id" placeholder="ID..."></th>
                            <th class="px-4 py-2"><input type="text" class="filter-input" data-filter-column="email" placeholder="Email..."></th>
                            <th class="px-4 py-2"><input type="text" class="filter-input" data-filter-column="name" placeholder="名前..."></th>
                            <th class="px-4 py-2"><input type="text" class="filter-input" data-filter-column="role" placeholder="役割..."></th>
                            <th class="px-4 py-2">
                                <select class="filter-input" data-filter-column="is_active">
                                    <option value="">全て</option>
                                    <option value="true">有効</option>
                                    <option value="false">無効</option>
                                </select>
                            </th>
                            <th class="px-4 py-2"><input type="date" class="filter-input" data-filter-column="last_login_at" placeholder="最終ログイン..."></th>
                            <th class="px-4 py-2"><input type="date" class="filter-input" data-filter-column="created_at" placeholder="作成日時..."></th>
                            <th class="px-4 py-2"><input type="number" class="filter-input" data-filter-column="play_count" placeholder="回数..."></th>
                            <th class="px-4 py-2"><input type="date" class="filter-input" data-filter-column="last_play_date" placeholder="最終プレイ日時..."></th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <div id="no-results-message" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>該当するユーザーが見つかりません。</p>
            </div>
             <div class="mt-4 flex flex-col sm:flex-row justify-between items-center">
                <div class="text-sm text-gray-600 mb-2 sm:mb-0">
                    <span id="pagination-info"></span>
                </div>
                <div class="flex gap-1">
                    <button id="prev-page-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="next-page-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="create-user-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-700">新規ユーザー作成</h2>
                <button id="close-create-user-modal-button" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="create-user-form">
                <div class="mb-4">
                    <label for="create-email" class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                    <input type="email" id="create-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="create-name" class="block text-sm font-medium text-gray-700 mb-1">名前 <span class="text-red-500">*</span></label>
                    <input type="text" id="create-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4 relative">
                    <label for="create-password" class="block text-sm font-medium text-gray-700 mb-1">パスワード <span class="text-red-500">*</span></label>
                    <input type="password" id="create-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10">
                    <span id="toggle-password-visibility" class="password-toggle-icon">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                <div class="mb-6">
                    <label for="create-role" class="block text-sm font-medium text-gray-700 mb-1">役割</label>
                    <input type="text" id="create-role" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-create-user-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md border border-gray-300 shadow-sm">キャンセル</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">作成</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-sm transform scale-95">
            <h2 id="confirmation-title" class="text-lg font-semibold text-gray-800 mb-4">確認</h2>
            <p id="confirmation-message" class="text-sm text-gray-600 mb-6">この操作を実行してもよろしいですか？</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirmation-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md border border-gray-300 shadow-sm">キャンセル</button>
                <button id="confirm-action-button" class="px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm">実行</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // Mock Data (Simulating Database)
        let users = [
            { id: 1, email: 'admin@example.com', name: '管理者ユーザー', password: 'password123', role: 'admin', is_active: true, last_login_at: '2024-05-28T10:00:00Z', created_at: '2023-01-15T09:00:00Z', updated_at: '2024-05-28T10:00:00Z', deleted_at: null },
            { id: 2, email: 'user1@example.com', name: '一般ユーザー壱', password: 'password123', role: 'user', is_active: true, last_login_at: '2024-05-29T14:30:00Z', created_at: '2023-02-20T11:00:00Z', updated_at: '2024-05-29T14:30:00Z', deleted_at: null },
            { id: 3, email: 'user2@example.com', name: '一般ユーザー弐', password: 'password123', role: 'user', is_active: false, last_login_at: '2024-03-10T18:00:00Z', created_at: '2023-03-01T16:00:00Z', updated_at: '2024-04-01T10:00:00Z', deleted_at: null },
            { id: 4, email: 'test@example.com', name: 'テストユーザー', password: 'password123', role: 'tester', is_active: true, last_login_at: null, created_at: '2024-05-01T09:00:00Z', updated_at: '2024-05-01T09:00:00Z', deleted_at: null },
            { id: 5, email: 'long.name.user.example.for.testing.layout@example.com', name: 'レイアウトテスト用長名前ユーザー', password: 'password123', role: 'user', is_active: true, last_login_at: '2024-05-25T12:00:00Z', created_at: '2024-04-10T09:00:00Z', updated_at: '2024-05-25T12:00:00Z', deleted_at: null },
            { id: 6, email: 'deleted@example.com', name: '削除済みユーザー', password: 'password123', role: 'user', is_active: false, last_login_at: '2023-12-01T10:00:00Z', created_at: '2023-11-01T09:00:00Z', updated_at: '2024-01-01T09:00:00Z', deleted_at: '2024-01-01T09:00:00Z' },
        ];

        let questionResults = [
            { id: 1, user_id: 1, question_id: 101, status: 'completed', started_at: '2024-05-28T09:50:00Z', submitted_at: '2024-05-28T10:00:00Z' },
            { id: 2, user_id: 2, question_id: 102, status: 'completed', started_at: '2024-05-29T14:00:00Z', submitted_at: '2024-05-29T14:30:00Z' },
            { id: 3, user_id: 2, question_id: 103, status: 'in_progress', started_at: '2024-05-30T10:00:00Z', submitted_at: null },
            { id: 4, user_id: 3, question_id: 104, status: 'completed', started_at: '2024-03-10T17:30:00Z', submitted_at: '2024-03-10T18:00:00Z' },
            { id: 5, user_id: 5, question_id: 201, status: 'completed', started_at: '2024-05-25T11:00:00Z', submitted_at: '2024-05-25T11:30:00Z' },
            { id: 6, user_id: 5, question_id: 202, status: 'completed', started_at: '2024-05-25T11:30:00Z', submitted_at: '2024-05-25T12:00:00Z' },
            { id: 7, user_id: 1, question_id: 105, status: 'timeout', started_at: '2024-05-20T10:00:00Z', submitted_at: '2024-05-20T10:30:00Z' },
        ];

        // --- Application State ---
        let currentSort = { column: 'id', direction: 'asc' };
        let currentFilters = {}; // { column: value, ... }
        let selectedUserIds = new Set();
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;

        // --- DOM Elements ---
        const createUserModal = document.getElementById('create-user-modal');
        const closeCreateUserModalButton = document.getElementById('close-create-user-modal-button');
        const cancelCreateUserButton = document.getElementById('cancel-create-user-button');
        const createUserForm = document.getElementById('create-user-form');
        const userTableBody = document.getElementById('user-table-body');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const bulkActionsContainer = document.getElementById('bulk-actions-container');
        const selectedCountSpan = document.getElementById('selected-count');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmActionButton = document.getElementById('confirm-action-button');
        const cancelConfirmationButton = document.getElementById('cancel-confirmation-button');
        let currentConfirmAction = null;

        const hamburgerButton = document.getElementById('hamburger-button');
        const hamburgerMenuModal = document.getElementById('hamburger-menu-modal');
        const closeHamburgerModalButton = document.getElementById('close-hamburger-modal-button');
        
        const globalSearchInput = document.getElementById('global-search-input');
        const noResultsMessage = document.getElementById('no-results-message');

        const prevPageButton = document.getElementById('prev-page-button');
        const nextPageButton = document.getElementById('next-page-button');
        const paginationInfo = document.getElementById('pagination-info');
        const toastContainer = document.getElementById('toast-container');

        // --- Utility Functions ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A'; // Invalid date
            return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }
        
        function showToast(message, type = 'info') { // type can be 'success', 'error', 'info'
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Trigger reflow to enable animation
            toast.offsetHeight; 

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300); // Wait for fade out animation
            }, 3000); // Display toast for 3 seconds
        }

        // --- Data Aggregation ---
        function getUserPlayData(userId) {
            const userResults = questionResults.filter(qr => qr.user_id === userId);
            const play_count = userResults.length;
            let last_play_date = null;
            if (play_count > 0) {
                const dates = userResults.map(qr => qr.submitted_at || qr.started_at).filter(Boolean);
                if (dates.length > 0) {
                    last_play_date = new Date(Math.max(...dates.map(d => new Date(d).getTime())));
                }
            }
            return { play_count, last_play_date: last_play_date ? last_play_date.toISOString() : null };
        }

        // --- Rendering Functions ---
        function renderTable() {
            userTableBody.innerHTML = ''; // Clear existing rows

            let processedUsers = users.filter(user => !user.deleted_at); // Exclude deleted users by default

            // Apply Global Search
            const searchTerm = globalSearchInput.value.toLowerCase().trim();
            if (searchTerm) {
                processedUsers = processedUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.role && user.role.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply Column Filters
            Object.entries(currentFilters).forEach(([column, value]) => {
                if (value === null || value === undefined || value === '') return;
                const filterValue = String(value).toLowerCase();

                processedUsers = processedUsers.filter(user => {
                    let userValue;
                    if (column === 'is_active') {
                        userValue = String(user.is_active);
                    } else if (column.includes('_at') || column.includes('_date')) {
                         const playData = (column === 'last_play_date' || column === 'play_count') ? getUserPlayData(user.id) : {};
                         const dateFieldValue = column === 'last_play_date' ? playData.last_play_date : user[column];
                         if (!dateFieldValue) return false;
                         userValue = new Date(dateFieldValue).toISOString().split('T')[0]; // Compare YYYY-MM-DD
                    } else if (column === 'play_count') {
                        const playData = getUserPlayData(user.id);
                        userValue = String(playData.play_count);
                    }
                    else {
                        userValue = String(user[column] || '').toLowerCase();
                    }
                    return userValue.includes(filterValue);
                });
            });

            // Sort Data
            processedUsers.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'play_count' || currentSort.column === 'last_play_date') {
                    const playDataA = getUserPlayData(a.id);
                    const playDataB = getUserPlayData(b.id);
                    valA = currentSort.column === 'play_count' ? playDataA.play_count : (playDataA.last_play_date ? new Date(playDataA.last_play_date) : null);
                    valB = currentSort.column === 'play_count' ? playDataB.play_count : (playDataB.last_play_date ? new Date(playDataB.last_play_date) : null);
                } else {
                    valA = a[currentSort.column];
                    valB = b[currentSort.column];
                }


                // Handle null or undefined values by pushing them to the end
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination
            const totalItems = processedUsers.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            currentPage = Math.max(1, Math.min(currentPage, totalPages || 1)); // Ensure currentPage is valid

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedUsers = processedUsers.slice(startIndex, endIndex);

            if (paginatedUsers.length === 0) {
                noResultsMessage.classList.remove('hidden');
                userTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">データがありません。</td></tr>`;
            } else {
                noResultsMessage.classList.add('hidden');
            }

            paginatedUsers.forEach(user => {
                const playData = getUserPlayData(user.id);
                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 ${selectedUserIds.has(user.id) ? 'bg-blue-100' : ''}`;
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="checkbox" class="row-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" data-user-id="${user.id}" ${selectedUserIds.has(user.id) ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${user.id}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 truncate" title="${user.email}">${user.email}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 truncate" title="${user.name}">${user.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${user.role || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.is_active ? '有効' : '無効'}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(user.last_login_at)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(user.created_at)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-center">${playData.play_count}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(playData.last_play_date)}</td>
                `;
                userTableBody.appendChild(tr);
            });
            updateBulkActionUI();
            updatePaginationControls(totalItems, totalPages);
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('.sortable .sort-icon').forEach(icon => {
                icon.classList.remove('fa-sort-up', 'fa-sort-down', 'active');
                icon.classList.add('fa-sort'); // Default icon
            });
            const activeSortIcon = document.querySelector(`.sortable[data-sort="${currentSort.column}"] .sort-icon`);
            if (activeSortIcon) {
                activeSortIcon.classList.remove('fa-sort');
                activeSortIcon.classList.add(currentSort.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down', 'active');
            }
        }
        
        function updatePaginationControls(totalItems, totalPages) {
            if (totalItems === 0) {
                 paginationInfo.textContent = "0 件";
            } else {
                 paginationInfo.textContent = `${(currentPage - 1) * ITEMS_PER_PAGE + 1} - ${Math.min(currentPage * ITEMS_PER_PAGE, totalItems)} / ${totalItems} 件`;
            }

            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages || totalPages === 0;
        }


        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex'); // For flex centering
            // Animate in
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalElement.querySelector('.modal-content').classList.remove('scale-95');
                modalElement.querySelector('.modal-content').classList.add('scale-100');
            }, 10); // Small delay to ensure transition is applied
        }

        function closeModal(modalElement) {
            modalElement.querySelector('.modal-content').classList.remove('scale-100');
            modalElement.querySelector('.modal-content').classList.add('scale-95');
            modalElement.classList.add('opacity-0');
            setTimeout(() => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('flex');
            }, 250); // Match transition duration
        }

        // --- Event Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();

            // Create User Modal
            document.getElementById('create-user-button').addEventListener('click', () => {
                createUserForm.reset(); // Clear form
                document.getElementById('create-password').type = 'password'; // Reset password visibility
                document.querySelector('#toggle-password-visibility i').classList.remove('fa-eye-slash');
                document.querySelector('#toggle-password-visibility i').classList.add('fa-eye');
                openModal(createUserModal);
            });
            closeCreateUserModalButton.addEventListener('click', () => closeModal(createUserModal));
            cancelCreateUserButton.addEventListener('click', () => closeModal(createUserModal));

            createUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newUser = {
                    id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                    email: document.getElementById('create-email').value,
                    name: document.getElementById('create-name').value,
                    password: document.getElementById('create-password').value, // In a real app, hash this
                    role: document.getElementById('create-role').value || null,
                    is_active: true,
                    last_login_at: null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    deleted_at: null
                };
                // Basic validation (e.g., check if email exists)
                if (users.some(u => u.email === newUser.email && !u.deleted_at)) {
                    showToast('エラー: このEmailは既に使用されています。', 'error');
                    return;
                }
                users.push(newUser);
                closeModal(createUserModal);
                renderTable();
                showToast('ユーザーが正常に作成されました。', 'success');
            });
            
            document.getElementById('toggle-password-visibility').addEventListener('click', () => {
                const passwordInput = document.getElementById('create-password');
                const icon = document.querySelector('#toggle-password-visibility i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            // Table Sorting
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    currentPage = 1; // Reset to first page on sort
                    renderTable();
                });
            });
            
            // Table Filtering (Column-specific and Global)
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', () => { // 'input' for immediate filtering
                    const column = input.dataset.filterColumn;
                    if (column) { // Column specific filter
                        currentFilters[column] = input.value;
                    }
                    currentPage = 1; // Reset to first page on filter
                    renderTable();
                });
            });
            globalSearchInput.addEventListener('input', () => {
                currentPage = 1;
                renderTable();
            });

            // Row Selection
            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const userId = parseInt(checkbox.dataset.userId);
                    if (isChecked) {
                        selectedUserIds.add(userId);
                    } else {
                        selectedUserIds.delete(userId);
                    }
                });
                updateBulkActionUI();
                renderTable(); // Re-render to update row highlighting
            });

            userTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('row-checkbox')) {
                    const userId = parseInt(e.target.dataset.userId);
                    if (e.target.checked) {
                        selectedUserIds.add(userId);
                    } else {
                        selectedUserIds.delete(userId);
                    }
                    selectAllCheckbox.checked = selectedUserIds.size > 0 && selectedUserIds.size === document.querySelectorAll('.row-checkbox').length;
                    updateBulkActionUI();
                    renderTable(); // Re-render to update row highlighting
                }
            });

            // Bulk Actions
            document.getElementById('activate-selected-button').addEventListener('click', () => {
                if (selectedUserIds.size === 0) return;
                openConfirmationModal(
                    '選択したユーザーを有効化',
                    `${selectedUserIds.size}人のユーザーを有効化します。よろしいですか？`,
                    () => {
                        selectedUserIds.forEach(id => {
                            const user = users.find(u => u.id === id);
                            if (user) {
                                user.is_active = true;
                                user.updated_at = new Date().toISOString();
                            }
                        });
                        clearSelectionAndRefresh();
                        showToast(`${selectedUserIds.size}人のユーザーを有効化しました。`, 'success');
                    },
                    'bg-green-500 hover:bg-green-600'
                );
            });

            document.getElementById('deactivate-selected-button').addEventListener('click', () => {
                 if (selectedUserIds.size === 0) return;
                openConfirmationModal(
                    '選択したユーザーを無効化',
                    `${selectedUserIds.size}人のユーザーを無効化します。よろしいですか？`,
                    () => {
                        selectedUserIds.forEach(id => {
                            const user = users.find(u => u.id === id);
                            if (user) {
                                user.is_active = false;
                                user.updated_at = new Date().toISOString();
                            }
                        });
                        clearSelectionAndRefresh();
                        showToast(`${selectedUserIds.size}人のユーザーを無効化しました。`, 'info');
                    },
                    'bg-yellow-500 hover:bg-yellow-600'
                );
            });

            document.getElementById('delete-selected-button').addEventListener('click', () => {
                 if (selectedUserIds.size === 0) return;
                openConfirmationModal(
                    '選択したユーザーを削除',
                    `${selectedUserIds.size}人のユーザーを削除します。この操作は元に戻せません。よろしいですか？`,
                    () => {
                        selectedUserIds.forEach(id => {
                            const user = users.find(u => u.id === id);
                            if (user) {
                                user.deleted_at = new Date().toISOString();
                                user.is_active = false; // Also mark as inactive
                                user.updated_at = new Date().toISOString();
                            }
                        });
                        clearSelectionAndRefresh();
                        showToast(`${selectedUserIds.size}人のユーザーを削除しました。`, 'error');
                    },
                    'bg-red-500 hover:bg-red-600'
                );
            });
            
            // Confirmation Modal Logic
            cancelConfirmationButton.addEventListener('click', () => closeModal(confirmationModal));
            confirmActionButton.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                closeModal(confirmationModal);
            });

            // Hamburger Menu
            hamburgerButton.addEventListener('click', () => openModal(hamburgerMenuModal));
            closeHamburgerModalButton.addEventListener('click', () => closeModal(hamburgerMenuModal));
            
            // Dummy Logout/My Page actions
            const handleLogout = () => {
                openConfirmationModal('ログアウト', 'ログアウトしますか？', () => {
                    showToast('ログアウトしました。', 'info');
                    closeModal(hamburgerMenuModal); // Close mobile menu if open
                }, 'bg-red-500 hover:bg-red-600');
            };
            const handleMyPage = () => {
                showToast('マイページへ移動します。（ダミー）', 'info');
                 closeModal(hamburgerMenuModal); // Close mobile menu if open
            };

            document.getElementById('logout-button-desktop').addEventListener('click', handleLogout);
            document.getElementById('my-page-button-desktop').addEventListener('click', handleMyPage);
            document.getElementById('logout-button-mobile').addEventListener('click', handleLogout);
            document.getElementById('my-page-button-mobile').addEventListener('click', handleMyPage);

            // Refresh Data
            document.getElementById('refresh-data-button').addEventListener('click', () => {
                // In a real app, this would fetch data from the server
                // For this demo, we just re-render.
                // You could add a small delay to simulate network latency
                showToast('データを更新しました。', 'info');
                // Reset filters and sort to default if needed, or maintain current state
                // currentFilters = {};
                // currentSort = { column: 'id', direction: 'asc' };
                // globalSearchInput.value = '';
                // document.querySelectorAll('.filter-input').forEach(input => input.value = '');
                currentPage = 1;
                renderTable();
            });

            // Pagination
            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            nextPageButton.addEventListener('click', () => {
                // Check against totalPages which is calculated in renderTable
                const totalItems = getFilteredAndSortedUsers().length;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        });
        
        function getFilteredAndSortedUsers() { // Helper for pagination totalPages check
            let processedUsers = users.filter(user => !user.deleted_at);
            const searchTerm = globalSearchInput.value.toLowerCase().trim();
            if (searchTerm) {
                processedUsers = processedUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.role && user.role.toLowerCase().includes(searchTerm))
                );
            }
            Object.entries(currentFilters).forEach(([column, value]) => {
                if (value === null || value === undefined || value === '') return;
                const filterValue = String(value).toLowerCase();
                processedUsers = processedUsers.filter(user => {
                    let userValue;
                     if (column === 'is_active') {
                        userValue = String(user.is_active);
                    } else if (column.includes('_at') || column.includes('_date')) {
                         const playData = (column === 'last_play_date' || column === 'play_count') ? getUserPlayData(user.id) : {};
                         const dateFieldValue = column === 'last_play_date' ? playData.last_play_date : user[column];
                         if (!dateFieldValue) return false;
                         userValue = new Date(dateFieldValue).toISOString().split('T')[0]; 
                    } else if (column === 'play_count') {
                        const playData = getUserPlayData(user.id);
                        userValue = String(playData.play_count);
                    }
                    else {
                        userValue = String(user[column] || '').toLowerCase();
                    }
                    return userValue.includes(filterValue);
                });
            });
            // Sorting is not strictly needed here just for total count, but included for completeness if this function were used elsewhere
            processedUsers.sort((a,b) => { /* ... same sort logic as in renderTable ... */ return 0;});
            return processedUsers;
        }

        function updateBulkActionUI() {
            if (selectedUserIds.size > 0) {
                bulkActionsContainer.classList.remove('hidden');
                bulkActionsContainer.classList.add('flex');
                selectedCountSpan.textContent = `${selectedUserIds.size} 件選択中`;
            } else {
                bulkActionsContainer.classList.add('hidden');
                bulkActionsContainer.classList.remove('flex');
            }
        }

        function clearSelectionAndRefresh() {
            selectedUserIds.clear();
            selectAllCheckbox.checked = false;
            renderTable();
        }
        
        function openConfirmationModal(title, message, onConfirm, buttonClass = 'bg-blue-600 hover:bg-blue-700') {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            currentConfirmAction = onConfirm;
            confirmActionButton.className = `px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm ${buttonClass}`;
            openModal(confirmationModal);
        }

    </script>
</body>
</html>
